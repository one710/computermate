name: Test

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

jobs:
  # ---------------------------------------------------------------------------
  # Stage 1 — Computer tests (2D matrix: suite × OS, all in parallel)
  # ---------------------------------------------------------------------------

  test:
    strategy:
      fail-fast: false
      matrix:
        suite: [native, playwright]
        os: [ubuntu-latest, macos-latest, windows-latest]

    runs-on: ${{ matrix.os }}
    name: ${{ matrix.suite }} (${{ matrix.os }})

    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-node@v4
        with:
          node-version: 22
          cache: yarn

      - run: yarn install --frozen-lockfile
      - run: yarn build

      # -- OS-specific deps (native only) ------------------------------------

      - name: Install Linux deps
        if: runner.os == 'Linux'
        run: |
          sudo apt-get update
          sudo apt-get install -y xvfb xdotool imagemagick

      - name: Install macOS deps
        if: matrix.suite == 'native' && runner.os == 'macOS'
        run: brew install cliclick

      # -- Playwright browser install ----------------------------------------

      - name: Install Playwright browsers
        if: matrix.suite == 'playwright'
        run: yarn playwright install --with-deps chromium

      # -- Run tests ---------------------------------------------------------

      - name: Run tests (Linux via Xvfb)
        if: matrix.suite == 'native' && runner.os == 'Linux'
        run: xvfb-run --auto-servernum yarn vitest run tests/native.test.ts --reporter=verbose
        env:
          DISPLAY: ":99"

      - name: Run native tests
        if: matrix.suite == 'native' && runner.os != 'Linux'
        run: yarn vitest run tests/native.test.ts --reporter=verbose

      - name: Run Playwright tests
        if: matrix.suite == 'playwright'
        run: |
          if [ "${{ runner.os }}" = "Linux" ]; then
            xvfb-run --auto-servernum yarn vitest run tests/playwright.test.ts --reporter=verbose
          else
            yarn vitest run tests/playwright.test.ts --reporter=verbose
          fi

  # ---------------------------------------------------------------------------
  # Stage 2 — Docker Integration (runs in parallel with Stage 1)
  # ---------------------------------------------------------------------------

  test-docker:
    runs-on: ubuntu-latest
    name: docker-http integration
    steps:
      - uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - uses: actions/setup-node@v4
        with:
          node-version: 22
          cache: yarn

      - run: yarn install --frozen-lockfile

      - name: Build Docker image
        run: docker build -t computermate .

      - name: Run Docker integration tests
        run: yarn test:docker --reporter=verbose

  # ---------------------------------------------------------------------------
  # Stage 3 — Master Integration (runs after all tests pass)
  # ---------------------------------------------------------------------------

  integration:
    runs-on: ubuntu-latest
    name: mcp-server integration
    needs: [test, test-docker]

    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-node@v4
        with:
          node-version: 22
          cache: yarn

      - run: yarn install --frozen-lockfile
      - run: yarn build

      - name: Install Linux deps
        run: |
          sudo apt-get update
          sudo apt-get install -y xvfb xdotool imagemagick

      - name: Run MCP server integration tests
        run: xvfb-run --auto-servernum yarn vitest run tests/mcp-server.test.ts --reporter=verbose
        env:
          DISPLAY: ":99"
